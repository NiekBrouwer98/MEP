---
title: "Danenberg Reproduction"
author: "Niek Brouwer"
date: "`r Sys.Date()`"
output: html_document
---

```{r introduction, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Here we aim to reproduce the results of the paper Breast tumor microenvironment structures are associated with genomic features and clinical outcome by Danenberg et al. (https://www.nature.com/articles/s41588-022-01041-y).
We focus on the description of the spatial organization of the TME as presented in figures 4b,d,f and its prognostic impact as seen in figure 6.

The separation and phenotype classification of single cells is not reproduced and this is retrieved from the original paper.

```{r data}
library(tidyverse)
cell_neighbors <- read_csv("/DATA/share/Spatial/toPublicRepository/CellNeighbours.csv")
images <- unique(cell_neighbors[['ImageNumber']])
```

## Spatial graphs
1.	Generate spatial graphs for epithelial and non-epithelial cells per image, exclude perivascular cells.
```{r spatial graphs}
library(igraph)

#Split dataset in tumor and stromal cells
tumour <- subset(cell_neighbors, (from_is_epithelial == T & to_is_epithelial == T)
& (from_is_perivascular == F & to_is_perivascular == F))
stromal <- subset(cell_neighbors, (from_is_epithelial == F & to_is_epithelial == F) 
	& (from_is_perivascular == F & to_is_perivascular == F))

```

## Community detection
2.	Detect communities based on random walks

```{r community detection}
n_threads <- parallel::detectCores()


```


## Connectivity profiles
3.	Define connectivity profiles for all communities as vertex degree per phenotype

## Cluster communities
4.	Cluster with Wardâ€™s method for hierarchical clustering

## Validation
5.	Validate reproducibility by training a random forest classifier on connectivity profiles

## Additional properties
6.	Compute number of vertices, number of edges, diameter, density, transitivity and assortativity and Shannon diversity by cell phenotype.
