---
title: "alberto_results"
author: "Niek Brouwer"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: "hide"
params:
  save_files:
    value: FALSE
    choices:
      - FALSE
      - TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this document we analyse the results from the Weibull parameter estimation on the METABRIC dataset.

```{r, include=FALSE}
library(here)
library(ggplot2)
library(tidyverse)
library(ggrepel)
library(fst)
source(here("UtilityFunctions.R"))
source(here("MEP_UtilityFunctions.R"))
library(Hmisc)
library(knitr)
library(tidyverse)
library(corrplot)
library(gridExtra)
library(cowplot)
library(grid)
library(ComplexHeatmap)
library(tidyHeatmap)
library(umap)
library(circlize)
library(dplyr)
library(ggsignif)
library(ggpubr)

projectSeed <- 89230689
set.seed(projectSeed)
```


## Load data

```{r}
cells <- getCells()
clinical_data <- read_fst(here('DATA/IMCClinical.fst'))
# clinical_data <- read_tsv(here('DATA/brca_metabric_clinical_data.tsv'))
clinical_data <- merge(x= clinical_data, unique(cells %>% select(c(ImageNumber, metabric_id))), by.x='metabric_id',by.y='metabric_id', all.y=T)
# clinical_data <- merge(x=clinical_data, y= clinical_data_Danenberg %>% select(c(metabric_id, IntClust)),by.x='Sample ID', by.y='metabric_id',all.x=T)

combinations <- getCombinations()
all_parameters <- getALLParameters()

# Compute means of each combination
means <- all_parameters %>% 
  group_by(phenotype_from, phenotype_to ) %>% 
  summarise(mean_shape = mean(shape),
            mean_scale  = mean(scale))

all_distances_data <- readRDS(file  = here('scratch/AUCScaledSlides_300_ALL.rds'))
all_distances_data <- all_distances_data %>% as_tibble %>%
  mutate(distance_window = WinMean) %>%
  mutate(phenotype_combo = paste(phenotype_from, phenotype_to, sep='_to_')) %>%
  dplyr::select(tnumber, phenotype_combo, `N.per.mm2.scaled`, distance_window) %>%
  mutate(new = `N.per.mm2.scaled` * 1000) %>%
  mutate(new =round(new))

cell_occurences <- getCellCounts()

```

## Initial parameters
Prior to parameter estimation, parameters are initialized on data on the [0,100] interval using the 'fitdist' package. This is a quick and sloppy estimation.

Samples can be divided into four categories:
1. No initialization and no estimation possible (combination does not occur)
2. No initialization, but estimation (distances outside [0,100] interval or initialization exceeded time)
3. Initialization, but no estimation (Not possible to fit Weibull distribution)
4. No initialization and no estimation, although combination is present.

This last category requires more analyses to find out why the estimation failed.

```{r}
initial_parameters <- tibble()
for (c in combinations){
    init_params <- readRDS(here(paste('scratch/init_parameters/init_params_', c,'.rds', sep='')))
    initial_parameters <- bind_rows(initial_parameters, init_params)
}

initial_parameters <- merge(x= initial_parameters %>%
                              filter(term=='shape') %>%
                              select(c(tnumber,combo, estimate))%>%
                              rename(shape = estimate),
                            y= initial_parameters %>%
                              filter(term=='scale') %>%
                              select(c(tnumber,combo, estimate)) %>% 
                              rename(scale = estimate),
                            by.x=c('tnumber', 'combo'), 
                            by.y= c('tnumber', 'combo')) %>%
                      unite('unique_sample', c(tnumber, combo), remove=FALSE) %>%
                      separate(combo, into=c('phenotype_from','phenotype_to'),sep='_to_', remove=FALSE) %>% 
                      rename(phenotype_combo = combo)

not_estimated_samples <- initial_parameters  %>% filter(! unique_sample %in% all_parameters$unique_sample)
not_initialized_samples <- all_parameters %>% filter(unique_sample %in% setdiff(all_parameters$unique_sample, intersect(initial_parameters$unique_sample, all_parameters$unique_sample)))

cell_occurences_combinations <- getCombinationCounts()

all_possible_samples <- cell_occurences_combinations %>% filter(n_to > 0 & n_from > 0)

not_estimated_and_initialized_samples <- cell_occurences_combinations %>% filter(! unique_sample %in% all_parameters$unique_sample) %>% filter(! unique_sample %in% initial_parameters$unique_sample) %>% filter(n_to > 0 & n_from > 0)

print(paste('Number of samples possible to estimate (combination exists):', nrow(all_possible_samples)))
print(paste('Total number of samples from which the parameters are initialized:', nrow(initial_parameters), '(', round(nrow(initial_parameters)*100/nrow(all_possible_samples),2), '%)'))
print(paste('Total number of samples from which the parameters are estimated:', nrow(all_parameters), '(', round(nrow(all_parameters)*100/nrow(all_possible_samples),2), '%)'))
print(paste('Number of samples from which the parameters are not estimated and not initialized:', nrow(not_estimated_and_initialized_samples),'(', round(nrow(not_estimated_and_initialized_samples)*100/nrow(all_possible_samples),2), '%)'))

```

```{r}
result = c()
for (i in 1:100){
  more <- (all_possible_samples %>% filter(n_to > i & n_from > i))
  percentage <- nrow(more[(more$unique_sample %in% estimated$unique_sample),])/nrow(more)
  result = c(result,percentage)
}

ggplot(data =tibble(n_cells = 1:100, estimated = result*100)) + geom_point(aes(x=n_cells, y=estimated)) + theme_bw() + ylab('percentage estimated') + xlab('number of cells in combination') + ylim(0,100)
ggsave(here('output/Missing_estimations_analysis/estimated_samples_percentages.pdf'),width=7,height=5)

ggplot(all_parameters) + geom_bar(aes(x=phenotype_combo))
```
```{r}
i = 99
print(show_slide(i, c('Fibroblasts', 'CK^{lo}ER^{lo}')))
ggsave(paste('output/Slides/exploreslide_',i,'.pdf',sep=''), width = 15, height=10)
```
How many combinations have a valid number of estimations? 

```{r}
print(nrow(all_parameters %>% count(phenotype_combo) %>% filter(n > 50)))
```

## Failed parameter estimations
Which combinations could not be estimated at all?

```{r}
not_estimated_combinations <- setdiff(combinations, unique(all_parameters$phenotype_combo))
print(str_sort(not_estimated_combinations))
```


Look at the slides of the samples that were not estimated, but initialized.

```{r}
sample_points_notest <- sample_n(not_estimated_samples, 5)

for (row in 1:nrow(sample_points_notest)){
  print(show_distance_distribution(sample_points_notest[row,]))
}

if (params$save_files){
ggsave(here('output/Missing_estimations_analysis/not_estimated_samples.pdf'), plot = plot_grid(show_distance_distribution(sample_points_notest[1,]),show_distance_distribution(sample_points_notest[2,]),show_distance_distribution(sample_points_notest[3,]),
          show_distance_distribution(sample_points_notest[4,]),show_distance_distribution(sample_points_notest[5,]), ncol=1), width= 10, height=20 )
}
  
```

Look at the slides of the samples that were not initialized, but estimated.

```{r}

sample_points_notinit <- sample_n(not_initialized_samples, 5)

for (row in 1:nrow(sample_points_notinit)){
  print(show_distance_distribution(sample_points_notinit[row,]))

}

if (params$save_files){
ggsave(here('output/Missing_estimations_analysis/not_init_samples.pdf'), plot = plot_grid(show_distance_distribution(sample_points_notinit[1,]),show_distance_distribution(sample_points_notinit[2,]),show_distance_distribution(sample_points_notinit[3,]),
          show_distance_distribution(sample_points_notinit[4,]),show_distance_distribution(sample_points_notinit[5,]), ncol=1), width= 10, height=20 )
}

```

Look at the slides of the samples that were not initialized and not estimated.

```{r}
show_distance_distribution_without_estimate <- function(sample){
  sample_distance_data <- all_distances_data %>% filter(tnumber %in% sample$tnumber) %>% filter(phenotype_combo %in%
                                                                                                                 sample$phenotype_combo)
  
  dist <- ggplot(data= sample_distance_data %>% filter(tnumber == sample['tnumber'][[1]]) %>% filter(phenotype_combo == sample['phenotype_combo'][[1]])) +   geom_bar(aes(x=distance_window, y=N.per.mm2.scaled), stat="identity",alpha=0.5) +
  xlim(0,300) + theme_bw() + theme(legend.position = "none") + ggtitle(label = sample['phenotype_combo'][[1]])
  
  slide <- ggplot(data=cells%>% filter(ImageNumber == sample['tnumber'][[1]]) %>% 
                 filter(meta_description == sample['phenotype_from'][[1]] | meta_description == sample['phenotype_to'][[1]])) + 
    geom_point(aes(x=Location_Center_X, y=Location_Center_Y, color=meta_description), alpha =0.5) + 
    theme_bw() + ggtitle(paste('imagenumber: ', sample['tnumber'][[1]]))

return(plot_grid(dist, slide))
                         
}
sample_points_notinit_and_notest <- sample_n(not_estimated_and_initialized_samples, 5)

for (row in 1:nrow(sample_points_notinit_and_notest)){
  print(show_distance_distribution_without_estimate(sample_points_notinit_and_notest[row,]))

}

if (params$save_files){
ggsave(here('output/Missing_estimations_analysis/not_init_and_estimated_samples.pdf'), plot = plot_grid(show_distance_distribution_without_estimate(sample_points_notinit_and_notest[1,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[2,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[3,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[4,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[5,]), ncol=1), width= 10, height=20 )
}

```

We would like to find out why our method fails in initializing and estimating certain samples.
A possible explanation is that the combination exist, but is very rare.

**Haakje: Zijn de samples met hoge counts in cell types met veel 0 counts, verrijkt in bepaaplde subtypes of iets dergelijks?**

```{r}

not_estimated_counts <- not_estimated_and_initialized_samples  %>% count(phenotype_combo) %>%
  separate(phenotype_combo, into=c('phenotype_from','phenotype_to'),sep='_to_', remove = FALSE)

not_estimated_matrix <- matrix(not_estimated_counts %>% pull(n), byrow = T, nrow = length(unique(not_estimated_counts %>% pull(phenotype_from))),
                                dimnames = list(unique(not_estimated_counts %>% pull(phenotype_from)), 
                                                unique(not_estimated_counts %>% pull(phenotype_to))))

hm  <- Heatmap(not_estimated_matrix,
               name = 'number of \n unestimated samples', column_title = 'phenotype_to', row_title = 'phenotype_from',
                row_names_gp = gpar(fontsize=6), column_names_gp = gpar(fontsize=6),
                cluster_rows = T, cluster_columns =  T)

print(hm)
if (params$save_files){
save_pdf(hm, here('output/Missing_estimations_analysis/notestimatedcounts.pdf'), width=10, height=6)
}

medians_from <- not_estimated_and_initialized_samples %>% group_by(phenotype_from) %>% summarise(median = median(n_from))
medians_to <- not_estimated_and_initialized_samples %>% group_by(phenotype_to) %>% summarise(median = median(n_to))

ggplot(data=not_estimated_and_initialized_samples) + geom_boxplot(aes(x=phenotype_from, y=n_from))  + theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + geom_text(data=medians_from, aes(x=phenotype_from,y=median, label=median), 
              size = 3, vjust = -15,color='red') + ggtitle('cell type count with medians in red')

if (params$save_files){
ggsave(paste(here('output/Missing_estimations_analysis/'), 'notestimatedcounts_boxplot1.pdf', sep=''))
}

ggplot(data=not_estimated_and_initialized_samples) + geom_boxplot(aes(x=phenotype_to, y=n_to))  + theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + geom_text(data=medians_to, aes(x=phenotype_to,y=median, label=median), 
              size = 3, vjust = -15,color='red') + ggtitle('cell type count with medians in red')

if (params$save_files){
ggsave(paste(here('output/Missing_estimations_analysis/'), 'notestimatedcounts_boxplot2.pdf', sep=''))
}


```

There are still samples with high counts, but without estimation.

```{r}
print(paste('Number of unestimated samples with phenotype_to or phenotype_from > 1000:', nrow(not_estimated_and_initialized_samples %>% filter(n_from > 1000 | n_to > 1000))))
sample_points_notinit_and_notest <- sample_n(not_estimated_and_initialized_samples %>% filter(n_from > 1000 | n_to > 1000),5)

for (row in 1:nrow(sample_points_notinit_and_notest)){
  print(show_distance_distribution_without_estimate(sample_points_notinit_and_notest[row,]))
}

if (params$save_files){
ggsave(here('output/Missing_estimations_analysis/one_count_high_failed_samples.pdf'), plot = plot_grid(show_distance_distribution_without_estimate(sample_points_notinit_and_notest[1,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[2,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[3,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[4,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[5,]), ncol=1), width= 10, height=20 )
}
```

There are also samples with high counts of both from and to cell type.

```{r}
print(paste('Number of unestimated samples with both phenotype_to and from count 50+ :', nrow(not_estimated_and_initialized_samples %>% filter(n_from > 50 & n_to > 50))))
sample_points_notinit_and_notest <- not_estimated_and_initialized_samples %>% filter(n_from > 50 & n_to > 50)

for (row in 1:nrow(sample_points_notinit_and_notest)){
  print(show_distance_distribution_without_estimate(sample_points_notinit_and_notest[row,]))
}
  
if (params$save_files){
ggsave(here('output/Missing_estimations_analysis/both_count_high_failed_samples1.pdf'), plot = plot_grid(show_distance_distribution_without_estimate(sample_points_notinit_and_notest[1,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[2,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[3,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[4,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[5,]), ncol=1), width= 10, height=20)
  
ggsave(here('output/Missing_estimations_analysis/both_count_high_failed_samples2.pdf'), plot = plot_grid(
  show_distance_distribution_without_estimate(sample_points_notinit_and_notest[6,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[7,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[8,]),
            show_distance_distribution_without_estimate(sample_points_notinit_and_notest[9,]),
          show_distance_distribution_without_estimate(sample_points_notinit_and_notest[10,]), ncol=1), width= 10, height=20 )
}

```


### Exploration of unestimated samples

Are the distributions of unestimated samples with high counts very different from the other distributions?

```{r}
estimated_distances <- all_distances_data %>%
unite('unique_sample', c(tnumber, phenotype_combo), remove=F) %>% filter(unique_sample %in% all_parameters$unique_sample)

compare_samples <- function(highlight_tnumber, c){
  dist <- bind_rows(estimated_distances %>% filter(phenotype_combo == c) %>% group_by(distance_window)%>% dplyr::summarize(N.per.mm2.scaled = mean(N.per.mm2.scaled)) %>%
                      mutate(plot = ' other estimates'), all_distances_data %>% filter((tnumber == highlight_tnumber & phenotype_combo == c)) %>% mutate(plot = 'highlighed estimate')) %>%
    ggplot(aes(x=distance_window)) + geom_histogram(bins=300) + theme_bw()
  # ggplot(aes(x=distance_window, y=N.per.mm2.scaled, fill=plot)) +
  # geom_bar(stat="identity", position = position_identity(), alpha=0.5) + theme_bw() +
  #   ggtitle(paste(c, '(', length(unique(estimated_distances %>% filter(phenotype_combo == c) %>% pull(tnumber))), 'estimates)'))
  

return(dist)
}

sample_points_notinit_and_notest <- not_estimated_and_initialized_samples %>% filter(n_from > 50 & n_to > 50)
for (row in 1:nrow(sample_points_notinit_and_notest)){
  print(compare_samples(sample_points_notinit_and_notest[row,]['tnumber'][[1]],sample_points_notinit_and_notest[row,]['phenotype_combo'][[1]] ))
}

print(compare_samples(151, 'ER^{hi}CXCL12^{+}_to_ER^{hi}CXCL12^{+}' ))
ggsave(here('output/Alberto_reproduction/histogram_high_high.pdf'),width=10, height=6)

```

Are specific low counts correlated with  cancer subtype?

```{r}
heatmap_occurences <- function(dataset, occ_number, subtype){
  cell_occurences_categories <- dataset %>% mutate(category = ifelse(n_to > occ_number & n_from> occ_number, paste(as.character(occ_number),'+',sep=''), as.character(occ_number))) %>%
                                                                       group_by(phenotype_from, phenotype_to) %>%
                                                                                      count(category) %>% 
                                                                      mutate(n = n/ length(unique(dataset %>% pull(tnumber))))
  
  df <- cell_occurences_categories %>% filter(category == paste(as.character(occ_number),'+',sep=''))

  trans_df <- xtabs(n ~ phenotype_from + phenotype_to, df)
  hm <- Heatmap(trans_df, cluster_rows = T, cluster_columns = T, row_names_gp = gpar(fontsize=6), column_names_gp = gpar(fontsize=6),
                name = paste('sample percentage \n of type', subtype, '\n with', paste(as.character(occ_number),'+',sep=''), 'occ.'), column_title = 'phenotype_to', row_title = 'phenotype_from')
  
  print(hm)
  
  # if (params$save_files){
  # save_pdf(hm,paste('occurence_heatmap_type_', subtype,.pdf,sep='') width=6, height=4)
  # }
}

heatmap_occurences(cell_occurences_combinations, 0,'ALL')
subtypes = group_split(clinical_data %>% group_by(PAM50))
for (s in 1:length(subtypes)){
  subtype = subtypes[[s]]
  heatmap_occurences(cell_occurences_combinations %>% filter(tnumber %in% subtype$ImageNumber), 0,unique(subtype$PAM50))
}

get_combination_occurences <- function(){
  parameters_with_subtypes <- merge(all_parameters, clinical_data %>% select(c("ImageNumber", "Pam50 + Claudin-low subtype", "HER2 Status", "ER Status", "PR Status")), by.x='tnumber', by.y='ImageNumber')
  
  combination_occurences <- (parameters_with_subtypes %>% group_by(`Pam50 + Claudin-low subtype`, phenotype_combo) %>% summarise(n = n())) %>% rename(PAM50 = `Pam50 + Claudin-low subtype`) %>% separate(phenotype_combo, into=c('phenotype_from','phenotype_to'),sep='_to_', remove = FALSE)

  subtype_count <- clinical_data %>% group_by(`Pam50 + Claudin-low subtype`) %>% summarise(n_proportion = n()/794)

  combination_occurences <- merge(merge(combination_occurences, combination_occurences %>% group_by(phenotype_combo) %>% summarise(n_total = sum(n)), by='phenotype_combo'), subtype_count, by.x='PAM50', by.y='Pam50 + Claudin-low subtype') %>% mutate(expected_n = (n_proportion) * n_total)

  return(combination_occurences)
}

combination_occurences <- get_combination_occurences()

lvls <- combination_occurences %>% group_by(phenotype_from) %>% summarise(n=n()) %>% arrange(n) %>% pull(phenotype_from)

ggplot(data=combination_occurences) + geom_bar(aes(x=factor(phenotype_from, levels=lvls), y=n, fill=PAM50), stat="identity",position='fill') + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=7)) + facet_wrap(vars(phenotype_to), ncol = 8) + xlab('phenotype_from')

if (params$save_files){
ggsave(here('output/Missing_estimations_analysis/estimation_counts.pdf'), height=20, width=30)
}

ggplot(data=combination_occurences %>% filter(n_total > (794*0.5))) + geom_bar(aes(x=factor(phenotype_from, levels=lvls), y=n, fill=PAM50), stat="identity",position='fill') + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=7)) + facet_wrap(vars(phenotype_to), ncol = 8) + xlab('phenotype_from')

if (params$save_files){
ggsave(here('output/Missing_estimations_analysis/estimation_counts_50percent.pdf'), height=20, width=30)
}

dominant_estimations <- unique(combination_occurences %>% filter(n_total > (794*0.5)) %>% filter(n  > (expected_n*2) | n  < (expected_n*(1/2)))%>% pull(phenotype_combo))

ggplot(data=combination_occurences %>% filter(phenotype_combo %in% dominant_estimations)) + geom_bar(aes(x=factor(phenotype_from, levels=lvls), y=n, fill=PAM50), stat="identity",position='fill') + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=7)) + facet_wrap(vars(phenotype_to), ncol = 8) + xlab('phenotype_from')

if (params$save_files){
ggsave(here('output/Missing_estimations_analysis/dominant_estimation_counts.pdf'), height=20, width=30)
}

``` 


## Estimated parameters
Filter out the outliers.

```{r}
estimated_distances <- merge(estimated_distances, all_parameters %>% select(c(unique_sample, shape,scale)), by='unique_sample',all.y =T)
estimated_distances <- estimated_distances %>% mutate(predicted = dweibull(x=distance_window, shape=shape, scale=scale))
estimated_distances <- estimated_distances %>% mutate(residual = (predicted - N.per.mm2.scaled))
estimated_distances <- estimated_distances %>% mutate(sqt_residuals = residual^2)

RMSE <- estimated_distances %>% group_by(unique_sample) %>% 
  summarise(length_vector = c_across(cols = c(sqt_residuals)) %>% length(),
              sum_vector = c_across(cols = c(sqt_residuals)) %>% sum(),
              mean_error = sum_vector/length_vector,
              MSE = mean_error %>% sqrt())

quantiles <- as_tibble(quantile(RMSE$MSE,probs=c(seq(0,1,0.1),0.95,0.99,0.999))) %>% mutate(quantiles=paste(c(seq(0,1,0.1),0.95,0.99,0.999), '%'))

ggplot() + geom_point(data=RMSE,aes(x=MSE, y=1),alpha=0.05,size=5) + geom_point(data=quantiles, aes(x=value,y=1,color=quantiles),size=7,shape=3) + theme_bw()

threshold <- quantiles %>% filter(quantiles == '0.99 %') %>% pull(value)
outliers <- RMSE %>% filter(MSE > threshold) %>% pull(unique_sample)
```



Do the parameters look like a C-curve?

```{r plot all parameters}
ggplot() +
  geom_point(data = all_parameters %>% filter(!(unique_sample %in% outliers)), aes(x=shape, y=scale), alpha=0.1, size=0.5) +
  geom_density_2d(data = all_parameters %>% filter(!(unique_sample %in% outliers)), aes(x=shape, y=scale)) +
  theme_bw() +
  ylim(10,300) + xlim(0,6) +
  scale_y_log10() +
  xlab('Shape') + ylab('Scale') + ggtitle("Parameters with densities")

ggplot() +
  geom_point(data = all_parameters %>% filter((unique_sample %in% outliers)), aes(x=shape, y=scale), alpha=0.1, size=0.5) +
  theme_bw() +
  ylim(10,300) + xlim(0,6) +
  scale_y_log10() +
  xlab('Shape') + ylab('Scale') + ggtitle("Parameters of outliers")

if (params$save_files){
ggsave(paste(here('output/Alberto_reproduction/'), 'allparameters_withdensities.pdf', sep=''))
  }

ggplot() +
  geom_point(data = all_parameters %>% mutate(type='individual parameters'), aes(x=shape, y=scale, color=type), alpha=0.1, size=0.5) +
  geom_point(data = means %>% mutate(type='combination means'), alpha = 0.5, size = 1, aes(x=mean_shape, y=mean_scale,
                                                                  color = type, label=paste(phenotype_from, '_to_', phenotype_to, sep=''))) +
  theme_bw() +scale_color_manual(values=c("red","black"))  +
  labs(color=NULL) + 
  ylim(10,300) + xlim(0,6) +
  scale_y_log10() +
  xlab('Shape') + ylab('Scale') +ggtitle("Parameters with means")  + 
  guides(colour = guide_legend(override.aes = list(size=10)))

if (params$save_files){
ggsave(paste(here('output/Alberto_reproduction/'), 'allparameters_withmeans.pdf', sep=''))
}

Alberto_parameters <- read_tsv(here('DATA/global_weib_coeff_oct.tsv')) %>% mutate(type='NABUCCO')

ggplot() +
  geom_point(data = all_parameters %>% mutate(type='METABRIC'), aes(x=shape, y=scale, color=type), alpha=0.1, size=0.5) +
  geom_point(data = Alberto_parameters, aes(x=a, y=b, color=type),alpha = 0.5, size=0.5) +
  theme_bw() +scale_color_manual(values=c("black", "red")) +
  labs(color=NULL) + 
  ylim(10,300) + xlim(0,6) +
  scale_y_log10() +
  xlab('Shape') + ylab('Scale') + ggtitle("METABRIC and NABCUCCO parameters")  + 
  guides(colour = guide_legend(override.aes = list(size=10)))

if (params$save_files){
ggsave(paste(here('output/Alberto_reproduction/'), 'allparameters_withNABUCCO.pdf', sep=''))
}
```

Look at the extremes of the curve.

```{r}
# Pick extremes
# Divide the curve in areas and pick random from these areas
bottom_right <- sample_n(all_parameters %>% filter(shape > 5) %>% filter(scale < 20),1) %>% mutate(type= "low scale, high shape")
bottom_left <- sample_n(all_parameters %>% filter(shape < 2.5) %>% filter(shape >2) %>% filter(scale < 15),1)%>% mutate(type= "low scale, low shape")
mid_right <- sample_n(all_parameters %>% filter(shape > 2.8) %>% filter(shape <3.5) %>% filter(scale > 200) %>% 
                        filter(scale < 300) ,1)%>% mutate(type= "mid scale, high shape")
mid_left <- sample_n(all_parameters %>% filter(shape < 1) %>% filter(scale > 100)%>% 
                       filter(scale < 120),1 )%>% mutate(type= "mid scale, low shape")
top_right <- sample_n(all_parameters %>% filter(shape > 3.5) %>% filter(scale > 350) ,1)%>% mutate(type= "high scale, high shape")
top_left <- sample_n(all_parameters %>% filter(shape < 2) %>% filter(scale > 300),1 )%>% mutate(type= "high scale, low shape")
belly <- sample_n(all_parameters %>% filter(shape < 2.8) %>% filter(shape > 2.6) %>% filter(scale > 80) %>% filter(scale <90),1)%>% mutate(type= "belly")

sample_points <- rbind(bottom_right, bottom_left,mid_right, mid_left, top_right, top_left, belly)
print(sample_points$phenotype_combo)

ggplot() +
  geom_point(data = all_parameters, aes(x=shape, y=scale), alpha=0.1, size=0.5) +
  geom_point(data = sample_points, aes(x=shape, y=scale, color=type), alpha=1, size=3) +
  theme_bw() +
  ylim(10,300) + xlim(0,6) +
  scale_y_log10() +
  xlab('Shape') + ylab('Scale')

if (params$save_files){
ggsave(paste(here('output/Alberto_reproduction/'), 'extremeparameters.pdf', sep=''), width=6, height=4)
}

```

```{r}
ggplot() + 
  stat_function(fun = dweibull, args = list(shape = bottom_right$shape, scale = bottom_right$scale), aes(colour='low scale, high shape')) +
  stat_function(fun = dweibull, args = list(shape = bottom_left$shape, scale = bottom_left$scale),aes(colour='low scale, low shape')) +
  stat_function(fun = dweibull, args = list(shape = mid_left$shape, scale = mid_left$scale), aes(colour='mid scale, low scale')) +
  stat_function(fun = dweibull, args = list(shape = mid_right$shape, scale = mid_right$scale), aes(colour='mid scale, high scale')) +
  stat_function(fun = dweibull, args = list(shape = top_left$shape, scale = top_left$scale), aes(colour='high scale, low scale')) +
  stat_function(fun = dweibull, args = list(shape = top_right$shape, scale = top_right$scale), aes(colour='high scale, high shape')) +
  stat_function(fun = dweibull, args = list(shape = belly$shape, scale = belly$scale),aes(colour='belly')) +
  xlim(0,600) + theme_bw() + xlab('micron') + ylab('N')

if (params$save_files){
ggsave(paste(here('output/Alberto_reproduction/'), 'weibullcurves.pdf', sep=''),width=10, height=4)
}

```



```{r}
sample_distance_data <- merge(x = all_distances_data %>% filter(tnumber %in% sample_points$tnumber) %>% filter(phenotype_combo %in%
                                                                                                                 sample_points$phenotype_combo),
                              y = sample_points %>% select(c(phenotype_combo, shape, scale, type)), all.X =T, by.x='phenotype_combo', by.y='phenotype_combo') 
print_distances <- function(sample){
  return(ggplot(data= sample_distance_data %>% filter(tnumber == sample['tnumber'][[1]]) %>% filter(phenotype_combo == sample['phenotype_combo'][[1]])) +   geom_bar(aes(x=distance_window, y=N.per.mm2.scaled, fill=type), stat="identity",alpha=0.5) +
  stat_function(fun = dweibull, args = list(shape = sample['shape'][[1]], scale = sample['scale'][[1]]))+
  xlim(0,600) + ylim(0,0.05) + theme_bw() + theme(legend.position = "none") + ggtitle(label = sample['phenotype_combo'][[1]], subtitle = paste('shape:', round(sample['shape'][[1]],2), 'scale:',round(sample['scale'][[1]],2)))
  ) 
  }
  
print_slide <- function(sample){
  return(ggplot(data=cells%>% filter(ImageNumber == sample['tnumber'][[1]]) %>% 
                 filter(meta_description == sample['phenotype_from'][[1]] | meta_description == sample['phenotype_to'][[1]])) + 
    geom_point(aes(x=Location_Center_X, y=Location_Center_Y, color=meta_description), alpha =0.5) + 
    theme_bw() + ggtitle(label = paste('imagenumber: ', sample['tnumber'][[1]]), subtitle = sample['type'][[1]])
    )
}

for (row in 1:nrow(sample_points)){
  slide <- plot_grid(print_distances(sample_points[row,]),print_slide(sample_points[row,]))
  print(slide)
  if (params$save_files){
  ggsave(here(paste('output/Alberto_reproduction/estimated_sample',row, '.pdf', sep='')),slide, width=10, height=4)
  }
}
```


Take a better look at the belly points

```{r}
belly_points <- sample_n(all_parameters %>% filter(shape < 1.1) %>% filter(shape > 1) %>% filter(scale > 60) %>% filter(scale <61),1)
for (i in 1:8){
  belly <- sample_n(all_parameters %>% filter(shape < belly_points[i,'shape']+0.35) %>% filter(shape > belly_points[i,'shape']+0.25) %>% filter(scale > 60) %>% filter(scale <61),1)
  belly_points <- rbind(belly_points, belly)
}

ggplot() +
  geom_point(data = all_parameters, aes(x=shape, y=scale), alpha=0.1, size=0.5) +
  geom_point(data = belly_points, aes(x=shape, y=scale),colour='red', alpha=1, size=3) +
  theme_bw() +
  ylim(10,300) + xlim(0,6) +
  scale_y_log10() +
  xlab('Shape') + ylab('Scale')

if (params$save_files){
  ggsave(here('output/Alberto_reproduction/bellyline.pdf'), width=6, height=4)
}

belly_points <- belly_points %>% mutate(type = 'belly')

sample_distance_data <- merge(x = all_distances_data %>% filter(tnumber %in% belly_points$tnumber) %>% filter(phenotype_combo %in% belly_points$phenotype_combo),
                              y = belly_points %>% select(c(phenotype_combo, shape, scale, type)), all.X =T, by.x='phenotype_combo', by.y='phenotype_combo')

for (row in 1:nrow(belly_points)){
  slide <- plot_grid(print_distances(belly_points[row,]),print_slide(belly_points[row,]))
  print(slide)
  if (params$save_files){
  ggsave(here('output/Alberto_reproduction/bellyline_sample',i,'.pdf',sep=''), width=10, height=4)
}

}

```
Take a look at the the top points

```{r}
top_points <- sample_n(all_parameters %>% filter(shape < 1.1) %>% filter(shape > 1) %>% filter(scale > 370),1)
for (i in 1:9){
  top <- sample_n(all_parameters %>% filter(shape < top_points[i,'shape']+0.6) %>% filter(shape > top_points[i,'shape']+0.5) %>% filter(scale > 370) ,1)
  top_points <- rbind(top_points, top)
}

ggplot() +
  geom_point(data = all_parameters, aes(x=shape, y=scale), alpha=0.1, size=0.5) +
  geom_point(data = top_points, aes(x=shape, y=scale),colour='red', alpha=1, size=3) +
  theme_bw() +
  ylim(10,300) + xlim(0,6) +
  scale_y_log10() +
  xlab('Shape') + ylab('Scale')

if (params$save_files){
  ggsave(here('output/Alberto_reproduction/topline.pdf'), width=6, height=4)
}

top_points <- top_points %>% mutate(type = 'top_line')

sample_distance_data <- merge(x = all_distances_data %>% filter(tnumber %in% top_points$tnumber) %>% filter(phenotype_combo %in% top_points$phenotype_combo),
                              y = top_points %>% select(c(phenotype_combo, shape, scale, type)), all.X =T, by.x='phenotype_combo', by.y='phenotype_combo')

for (row in 1:nrow(top_points)){
  slide <- plot_grid(print_distances(top_points[row,]),print_slide(top_points[row,]))
  print(slide)
  if (params$save_files){
  ggsave(here('output/Alberto_reproduction/topline_sample',i,'.pdf',sep=''), width=10, height=4)
}

}
```


Now look at specific 'X to celltype' parameters similar to the paper by Gil-Jimenez et al.

```{r plot subset}
plot_parameters <- function(combi){
  point <- all_parameters %>%
    filter(phenotype_to == combi) %>%
    filter(phenotype_from %in% six_combinations) %>%
    ggplot(aes(x=shape, y=scale, color=phenotype_from)) +
    geom_point(alpha=0.4, size=3) +
    ylim(10,300) + xlim(0,6) +
    theme_bw() + scale_y_log10() +
    xlab('Shape') + ylab('Scale') +
    theme(legend.position='right') + ggtitle(paste('From X to ', combi)) + guides(colour = guide_legend(override.aes = list(size=10)))
  
  print(point)
  if (params$save_files){
  ggsave(paste(here('output/Alberto_reproduction/'), gsub("[[:punct:]]", "", combi), '_parameters.pdf', sep=''))
    }
}

six_combinations <- c('CK8-18^{hi}CXCL12^{hi}', 'B cells','CD4^{+} T cells',
                      'Macrophages','CD8^{+} T cells','T_{Reg} & T_{Ex}')

for (c in six_combinations){
  plot_parameters(c)
  grid <- plot_grid(ggplot(data = all_parameters %>%
    filter(phenotype_to == c) %>%
    filter(phenotype_from %in% six_combinations)) +
    geom_boxplot(aes(x=phenotype_from, y = shape)) +
    theme_bw() + ggtitle(paste('From X to ', c))+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)),
    ggplot(data = all_parameters %>%
    filter(phenotype_to == c) %>%
    filter(phenotype_from %in% six_combinations)) +
    geom_boxplot(aes(x=phenotype_from, y = scale)) +
    theme_bw() + ggtitle(paste('From X to ', c))+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)))

print(grid)
ggsave(paste(here('output/Alberto_reproduction/'),'boxplots', gsub("[[:punct:]]", "", c), '.pdf', sep=''))
}

```

Compare the parameters of the six cell types of Alberto with our parameters.
**Note:** We map the cell types of Alberto to our cell type classification, but both groups are not entirely the same and the cell type groups of Alberto contain more diverse cells.

```{r}
NABUCCO_parameters <- Alberto_parameters %>%
    separate(phenotype_combo, into=c('phenotype_from','phenotype_to'),sep='_to_', remove = FALSE) %>%
  mutate(type = 'NABUCCO') %>%
  mutate(METABRIC_type_from = ifelse(phenotype_from == "PanCK+", 'CK8-18^{hi}CXCL12^{hi}',
                                     ifelse(phenotype_from=="CD20+", 'B cells',
                                            ifelse(phenotype_from=='CD3+', 'CD4^{+} T cells',
                                                   ifelse(phenotype_from=="CD68+", 'Macrophages',
                                                          ifelse(phenotype_from=="CD8+CD3+",'CD8^{+} T cells',
                                                                 ifelse(phenotype_from=="CD3+FoxP3+",'T_{Reg} & T_{Ex}', 'negative'))))))) %>%
  mutate(METABRIC_type_to = ifelse(phenotype_to == "PanCK+", 'CK8-18^{hi}CXCL12^{hi}',
                                     ifelse(phenotype_to=="CD20+", 'B cells',
                                            ifelse(phenotype_to=='CD3+', 'CD4^{+} T cells',
                                                   ifelse(phenotype_to=="CD68+", 'Macrophages',
                                                          ifelse(phenotype_to=="CD8+CD3+",'CD8^{+} T cells',
                                                                 ifelse(phenotype_to=="CD3+FoxP3+",'T_{Reg} & T_{Ex}', 'negative'))))))) %>%
  select(c(a,b,METABRIC_type_to, METABRIC_type_from)) %>%
  rename(shape = a,
         scale = b,
         phenotype_from = METABRIC_type_from,
         phenotype_to = METABRIC_type_to) %>%
  mutate(type='NABUCCO')

NABUCCO_AND_METABRIC_parameters <- bind_rows(all_parameters %>% select(c(phenotype_from, phenotype_to, shape, scale)) %>%
                                               mutate(type='METABRIC'),
                                             NABUCCO_parameters) %>% filter(phenotype_to %in% six_combinations) %>% filter(phenotype_from %in% six_combinations)

res <- wilcox.test(NABUCCO_AND_METABRIC_parameters %>% filter(phenotype_from==six_combinations[1] & phenotype_to==six_combinations[1] & type=='METABRIC') %>% pull(shape),
                   NABUCCO_AND_METABRIC_parameters %>% filter(phenotype_from==six_combinations[1] & phenotype_to==six_combinations[1] & type=='NABUCCO') %>% pull(shape))
res


# https://rdrr.io/cran/ggsignif/man/stat_signif.html
for (c in six_combinations){
  group_ordered_shape <- with(NABUCCO_AND_METABRIC_parameters %>% filter(type=='METABRIC') %>% filter(phenotype_to==c),                       # Order boxes by median
                      reorder(phenotype_from,
                              shape,
                              median))

  data_ordered_shape <- NABUCCO_AND_METABRIC_parameters %>% filter(phenotype_to ==c)
  data_ordered_shape$phenotype_from <- factor(data_ordered_shape$phenotype_from,
                               levels = levels(group_ordered_shape))
  
  medians_shape <- data_ordered_shape %>% group_by(phenotype_from, type) %>% summarise(median = median(shape)) %>% arrange(factor(phenotype_from, levels = unique(group_ordered_shape)))
  res_shape <- cor.test(medians_shape %>% filter(type=='METABRIC') %>% pull(median),medians_shape %>% filter(type=='NABUCCO') %>% pull(median), method='spearman')
  
  group_ordered_scale <- with(NABUCCO_AND_METABRIC_parameters %>% filter(type=='METABRIC') %>% filter(phenotype_to==c),                       # Order boxes by median
                    reorder(phenotype_from,
                            scale,
                            median))

  data_ordered_scale <- NABUCCO_AND_METABRIC_parameters %>% filter(phenotype_to ==c)
  data_ordered_scale$phenotype_from <- factor(data_ordered_scale$phenotype_from,
                               levels = levels(group_ordered_scale))
  
  medians_scale <- data_ordered_scale %>% group_by(phenotype_from, type) %>% summarise(median = median(scale)) %>% arrange(factor(phenotype_from, levels = unique(group_ordered_scale)))
  res_scale <- cor.test(medians_scale %>% filter(type=='METABRIC') %>% pull(median),medians_scale %>% filter(type=='NABUCCO') %>% pull(median),method='spearman')  
  
  
  bp <- plot_grid(ggplot(data=data_ordered_shape %>%
    filter(phenotype_to == c) %>%
    filter(phenotype_from %in% six_combinations)) +
                    geom_boxplot(aes(x=phenotype_from, y=shape, fill=type)) +
    theme_bw() + ggtitle(paste('From X to', c), subtitle= paste('rho:', round(res_shape$estimate[[1]],4)))+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))  + theme(legend.position = "none"),
    # + stat_compare_means(aes(x=phenotype_from, y=shape, group = type), label = "p.format",size=2)

        ggplot(data=data_ordered_scale%>%
          filter(phenotype_to == c) %>%
          filter(phenotype_from %in% six_combinations)) +
                          geom_boxplot(aes(x=phenotype_from, y=scale, fill=type)) +
          theme_bw() + ggtitle(paste('From X to ', c), subtitle= paste('rho:', round(res_scale$estimate[[1]],4)))+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
        # + stat_compare_means(aes(x=phenotype_from, y=scale, group = type), label = "p.format",size=2)
    ,rel_widths = c(1.35,2))

  print(bp)
  if (params$save_files){
  ggsave(paste(here('output/Alberto_reproduction/'),'compare_boxplots',gsub("[[:punct:]]", "", c),'.pdf', sep=''))
      }
}

```
